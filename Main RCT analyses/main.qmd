---
title: "main"
format: 
  html:
    embed-resources: true
---

# Data Preparation and preprocessing

```{r setup, message=FALSE, warning=FALSE, include=FALSE}
#| echo: false
library(tidyverse)
library(mice)
library(broom)
```


```{r data-prep}
data = readRDS(here::here("Main RCT analyses/raw_data.rds"))
# We only keep the variables that are necessary for the primary analysis
data_primary <- data |>
  select(
    WINS.ID,
    Treatment,
    HEI2015_TOTAL_SCORE_bl,
    HEI2015_TOTAL_SCORE_el,
    HEI2015_TOTAL_SCORE_change,
    Age_years,
    Sex_bcf,
    Race2_bcf,
    Ethnicity_bcf,
    Education_grouped
  ) |>
  mutate(Completion = ifelse(is.na(HEI2015_TOTAL_SCORE_el), 0, 1), .after = Treatment)

head(data_primary)
```

The data have the following characteristics:

- It is a conditional randomized experiment. According to SAP(statistical analysis plan), it is stratified on sex.

- We do not know whether someone follows the treatment or not. We only know the treatment assignment. (This means $ITT_{Y,sex}=ATE_{sex}$)

- There are people failing to follow up at the end of the experiment. We need to handle this bias.

Notation

- $Z_i\in \left\{0,1\right\}$: treatment assignment for individual $i$.
- $Y_i$: outcome for individual $i$.
- $sex_i$: sex for individual $i$.
- $R_i\in \left\{0,1\right\}$: follow-up indicator for individual $i$. $R_i=1$ means individual $i$ has follow-up, otherwise $R_i=0$.
- $X_i$: baseline covariates for individual $i$.

If there is no missing follow-up, the ATE will be:
$$ATE_{male}=\mathbb{E}[Y_i\vert Z_i=1,sex_i=male]-\mathbb{E}[Y_i\vert Z_i=0,sex_i=male]$$
$$ATE_{female}=\mathbb{E}[Y_i\vert Z_i=1,sex_i=female]-\mathbb{E}[Y_i\vert Z_i=0,sex_i=female]$$
$$ATE=\mathbb{P}(male)ATE_{male}+\mathbb{P}(female)ATE_{female}$$
However, what if there are missing follow-up?

We still have conditional randomization:

$$Z_i\perp (Y_i(1),Y_i(0))\vert sex_i$$

Is this missing follow-up biased? We should check!

```{r check-missing-at-random}
# library(dplyr)
# library(broom)
# 
# # baseline covariates
# baseline_vars <- c(
#   "Treatment",
#   "Sex_bcf",
#   "HEI2015_TOTAL_SCORE_bl",
#   "Age_years",
#   "Race2_bcf",
#   "Ethnicity_bcf",
#   "Education_grouped"
# )
# 
# results <- lapply(baseline_vars, function(var){
#   f <- as.formula(paste("Completion ~", var))
#   fit <- glm(f, data=data_primary, family=binomial())
#   tidy(fit)[2, c("term","estimate","std.error","p.value")]
# }) %>%
#   bind_rows() %>%
#   mutate(
#     OR = exp(estimate),
#     CI_low  = exp(estimate - 1.96*std.error),
#     CI_high = exp(estimate + 1.96*std.error)
#   ) %>%
#   select(term, OR, CI_low, CI_high, p.value)
# 
# results
# 
# library(ggplot2)
# 
# ggplot(data_primary, aes(x = HEI2015_TOTAL_SCORE_bl, fill = factor(Completion))) +
#   geom_density(alpha = 0.5) +
#   labs(fill="Completed Follow-up",
#        title="Baseline HEI score vs. Follow-up completion") +
#   theme_minimal()
library(dplyr)
library(tidyr)
library(kableExtra)

make_missing_table <- function(data, var){
  data %>%
    mutate(Completion = factor(Completion, labels = c("Missed","Completed"))) %>%
    group_by(!!sym(var), Completion) %>%
    summarise(n = n(), .groups="drop") %>%
    group_by(!!sym(var)) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    pivot_wider(
      names_from = Completion,
      values_from = c(n, pct),
      names_glue = "{Completion}_{.value}"
    ) %>%
    mutate(
      # `More likely to miss?` = ifelse(`Missed_pct` > `Completed_pct`, "â¬† Yes", "No"),
      Variable = var
    ) %>%
    arrange(desc(`Missed_pct`)) %>%
    rename(Level = !!sym(var)) %>%
    select(Variable, everything())
}

vars_to_check <- c("Sex_bcf", "Education_grouped", "Race2_bcf",
                   "Ethnicity_bcf", "Treatment")

combined_table <- lapply(vars_to_check, function(v){
  make_missing_table(data_primary, v)
}) %>%
  bind_rows()

combined_table %>%
  kbl(
    caption = "Missingness Pattern Analysis by Demographic Variables",
    align = "llcccccc",
    booktabs = TRUE
  ) %>%
  kable_styling(
    full_width = FALSE,
    latex_options = c("striped", "hold_position")
  ) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1, valign = "top")

```

Maybe the missingness depends on baseline variables, therefore we use IPW.

We assume MAR(missing at random): $$R_i\perp Y_i(z)\vert (Z_i, X_i)$$

Then we can use IPW for follow-up.

Steps:

1. Model the probability of being followed:
$$\pi_i=\mathbb{P}(R_i\vert Z_i, sex_i, X_i)$$ using logistic regression

2. Define weights for complete cases:
$$w_i=\frac{1}{\hat{\pi}_i}$$ for $R_i=1$

3. Within each sex stratum $sex$, estimate the outcome means using Horvitz-Thompson type estimator:(we cannot directly use the formula in class because it is designed for estimation without missingness, although it is also Horvitz-Thompson type estimator)
$$\hat{\mu}_{HT}=\frac{1}{N}\sum_{i=1}^n\frac{Y_i}{\pi_i}$$

Using this type of estimator, we can set up the estimator for ATE for a given sex as:

$$\hat{\mu}^{IPW}_{z,sex}=\frac{1}{N_{sex}}\sum_{\left\{i:sex_i=sex\right\} }\frac{R_i\boldsymbol{1}\left\{Z_i=z\right\}Y_i}{\hat{\pi}_i\mathbb{P}(Z=z\vert sex)}$$
Proof that this is unbiased:

By LLN, we have $$\hat{\mu}_{z,sex}^{IPW}=\frac{1}{N_{sex}}\sum_{\left\{ i:sex_i=sex \right\}}{\frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)}}\rightarrow \mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)} \right] $$

$$\mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)} \right] =\mathbb{E} _{Z,X,Y}\left[ \mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)}\vert Z_i,X_i,Y_i \right] \vert sex \right] $$
For the inner expectation,
$$\mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)} \right] =\mathbb{E} _{Z,X,Y}\left[ \mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)}\vert Z_i,X_i,Y_i \right] \vert sex \right] $$
$$\mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)}\vert Z_i,X_i,Y_i \right] =\mathbb{E} \left[ R_i\vert Z_i,X_i,Y_i \right] \frac{1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z\vert sex)}$$

Plugging in,

$$\mathbb{E} _{Z,X,Y}\left[ \mathbb{E} \left[ \frac{R_i1\left\{ Z_i=z \right\} Y_i}{\hat{\pi}_i\mathbb{P} (Z=z|sex)}|Z_i,X_i,Y_i \right] |sex \right] =\mathbb{E} _{Z,X,Y}\left[ \frac{1\left\{ Z_i=z \right\} Y_i}{\mathbb{P} (Z=z|sex)}|sex \right] 
\\
=\mathbb{E} _{Z,X,Y}\left[ \frac{1\left\{ Z_i=z \right\} Y_i\left( z \right)}{\mathbb{P} (Z=z|sex)}|sex \right] 
\\
=\frac{\mathbb{E} \left[ Y_i\left( z \right) |sex \right] \mathbb{E} \left[ 1\left\{ Z_i=z \right\} |sex \right]}{\mathbb{P} (Z=z|sex)}
\\
=\mathbb{E} \left[ Y_i\left( z \right) |sex \right] $$



```{r estimator-for-ATE}
followup_model <- glm(
  Completion ~ Treatment + Sex_bcf +
    HEI2015_TOTAL_SCORE_bl + Age_years +
    Race2_bcf + Ethnicity_bcf + Education_grouped,
  data   = data_primary,
  family = binomial()
)

data_ipw <- data_primary |>
  mutate(
    Treatment_num = as.numeric(Treatment) - 1,
    pi_hat = predict(followup_model, type = "response"),
    w_ipw  = ifelse(Completion == 1, 1 / pi_hat, 0)
  )


estimate_by_sex <- function(df) {
  df_comp <- df[df$Completion == 1, ]
  
  N_treat <- sum(df$Treatment_num == 1)
  N_ctrl  <- sum(df$Treatment_num == 0)
  
  if (N_treat == 0 | N_ctrl == 0) {
    warning("One group missing in this sex stratum")
    return(tibble(
      N_treat = N_treat,
      N_ctrl  = N_ctrl,
      ATE_HT  = NA_real_
    ))
  }
  
  mu1_HT <- with(
    df_comp,
    sum(w_ipw * (Treatment_num == 1) * HEI2015_TOTAL_SCORE_el) / N_treat
  )
  
  mu0_HT <- with(
    df_comp,
    sum(w_ipw * (Treatment_num == 0) * HEI2015_TOTAL_SCORE_el) / N_ctrl
  )
  
  ATE_HT <- mu1_HT - mu0_HT
  
  tibble(
    N_treat = N_treat,
    N_ctrl  = N_ctrl,
    ATE_HT  = ATE_HT
  )
}

ests_by_sex <- data_ipw |>
  group_by(Sex_bcf) |>
  group_modify(~ estimate_by_sex(.x)) |>
  ungroup()

ests_by_sex

p_sex <- data_ipw |>
  count(Sex_bcf) |>
  mutate(p = n / sum(n)) |>
  select(Sex_bcf, p)

ATE_HT_overall <- ests_by_sex |>
  left_join(p_sex, by = "Sex_bcf") |>
  summarise(
    ATE_HT_overall = sum(p * ATE_HT, na.rm = TRUE)
  )

ATE_HT_overall
```



```{r}
set.seed(2025)
B <- 1000 

bootstrap_ipw_ate <- function(data, indices) {
  boot_data <- data[indices, ]
  
  followup_model <- glm(
    Completion ~ Treatment + Sex_bcf +
      HEI2015_TOTAL_SCORE_bl + Age_years +
      Race2_bcf + Ethnicity_bcf + Education_grouped,
    data   = boot_data,
    family = binomial()
  )
  
  boot_data <- boot_data |>
    mutate(
      Treatment_num = as.numeric(Treatment) - 1,
      pi_hat = predict(followup_model, type = "response"),
      w_ipw  = ifelse(Completion == 1, 1 / pi_hat, 0)
    )
  
  estimate_by_sex_boot <- function(df) {
    df_comp <- df[df$Completion == 1, ]
    
    N_treat <- sum(df$Treatment_num == 1)
    N_ctrl  <- sum(df$Treatment_num == 0)
    
    if (N_treat == 0 | N_ctrl == 0) {
      return(tibble(ATE_HT = NA_real_))
    }
    
    mu1_HT <- with(
      df_comp,
      sum(w_ipw * (Treatment_num == 1) * HEI2015_TOTAL_SCORE_el) / N_treat
    )
    
    mu0_HT <- with(
      df_comp,
      sum(w_ipw * (Treatment_num == 0) * HEI2015_TOTAL_SCORE_el) / N_ctrl
    )
    
    tibble(ATE_HT = mu1_HT - mu0_HT)
  }
  
  ests_by_sex <- boot_data |>
    group_by(Sex_bcf) |>
    group_modify(~ estimate_by_sex_boot(.x)) |>
    ungroup()
  
  p_sex <- boot_data |>
    count(Sex_bcf) |>
    mutate(p = n / sum(n))
  
  ATE_overall <- ests_by_sex |>
    left_join(p_sex, by = "Sex_bcf", relationship = "many-to-many") |>
    summarise(ATE = sum(p * ATE_HT, na.rm = TRUE)) |>
    pull(ATE)
  
  c(
    ATE_overall = ATE_overall,
    ATE_Female = ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Female"],
    ATE_Male = ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Male"]
  )
}

library(boot)
boot_results <- boot(
  data = data_primary,
  statistic = bootstrap_ipw_ate,
  R = B
)

boot_results

ci_overall <- boot.ci(boot_results, type = "perc", index = 1)
ci_female  <- boot.ci(boot_results, type = "perc", index = 2)
ci_male    <- boot.ci(boot_results, type = "perc", index = 3)

results_summary <- tibble(
  Estimand = c("Overall ATE", "ATE (Female)", "ATE (Male)"),
  Estimate = c(
    ATE_HT_overall$ATE_HT_overall,
    ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Female"],
    ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Male"]
  ),
  SE = c(
    sd(boot_results$t[, 1]),
    sd(boot_results$t[, 2]),
    sd(boot_results$t[, 3])
  ),
  CI_lower = c(
    ci_overall$percent[4],
    ci_female$percent[4],
    ci_male$percent[4]
  ),
  CI_upper = c(
    ci_overall$percent[5],
    ci_female$percent[5],
    ci_male$percent[5]
  )
)

print(results_summary, digits = 3)

library(ggplot2)
library(tidyr)

boot_dist <- tibble(
  Overall = boot_results$t[, 1],
  Female = boot_results$t[, 2],
  Male = boot_results$t[, 3]
) |>
  pivot_longer(everything(), names_to = "Stratum", values_to = "ATE")

ci_data <- boot_dist |>
  group_by(Stratum) |>
  summarise(
    lower = quantile(ATE, 0.025, na.rm = TRUE),
    upper = quantile(ATE, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

point_estimates <- tibble(
  Stratum = c("Overall", "Female", "Male"),
  Estimate = c(
    ATE_HT_overall$ATE_HT_overall,
    ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Female"],
    ests_by_sex$ATE_HT[ests_by_sex$Sex_bcf == "Male"]
  )
)



p = ggplot(boot_dist, aes(x = ATE)) +
  geom_histogram(bin = 1, alpha = 0.7, fill = "steelblue") +
  geom_vline(data = ci_data, aes(xintercept = lower), 
             color = "red", linetype = "dashed", linewidth = 0.8) +
  geom_vline(data = ci_data, aes(xintercept = upper), 
             color = "red", linetype = "dashed", linewidth = 0.8) +
  geom_vline(data = point_estimates, aes(xintercept = Estimate),
             color = "darkgreen", linewidth = 1) +
  facet_wrap(~ Stratum, scales = "free") +
  theme_minimal() +
  labs(title = "Bootstrap Distribution of IPW-ATE Estimates",
       subtitle = "Green line = point estimate, Red dashed lines = 95% CI",
       x = "ATE Estimate", 
       y = "Frequency")
ggsave(here::here("Main RCT analyses/fig1.pdf"), p, width=8, height=6)
```
# linear model by throwing away missing follow-up
```{r}
imputed_data = readRDS(here::here("Main RCT analyses/imputed_data.rds"))

model_hei <- lm(HEI2015_TOTAL_SCORE_change ~ HEI2015_TOTAL_SCORE_bl + 
                  Sex_bcf + Age_years + Race2_bcf + Ethnicity_bcf + 
                  Education_grouped + Treatment, 
                data = imputed_data$data)

summary(model_hei)

tidy(model_hei)

glance(model_hei)

par(mfrow = c(2, 2))
plot(model_hei)

```


```{r}
library(tidyverse)

df <- tribble(
  ~Method,                  ~ATE, ~CI_low, ~CI_high,
  "Deleting Missing Data\n(Naive, biased)", 2.93, 1.24, 4.62,
  "IPW",                    3.83, 0.94, 6.98,
  "MI Adjusted Model",      2.56, 0.90, 4.22
)

df$Method <- factor(df$Method, levels = rev(df$Method))

p = ggplot(df, aes(x = ATE, y = Method)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  geom_errorbarh(aes(xmin = CI_low, xmax = CI_high), height = 0.2, size = 1.1) +
  geom_point(size = 3) +
  theme_minimal(base_size = 14) +
  labs(
    x = "ATE Estimate",
    y = "",
    title = "Estimated ATE Methods"
  ) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )

ggsave(here::here("Main RCT analyses/fig2.pdf"), p, width=5, height=3)


```


```{r}
library(tidyverse)
library(cobalt)

library(tidyverse)
library(cobalt)

data_primary_complete <- data_primary %>%
  filter(Completion == 1) %>%  #
  drop_na(Age_years, Sex_bcf, Race2_bcf, Ethnicity_bcf, 
          Education_grouped, HEI2015_TOTAL_SCORE_bl)

bal_original <- bal.tab(
  Treatment ~ Age_years + Sex_bcf + Race2_bcf + 
    Ethnicity_bcf + Education_grouped + HEI2015_TOTAL_SCORE_bl,
  data = data_primary_complete,
  estimand = "ATE",
  s.d.denom = "pooled"
)

bal_imputed <- bal.tab(
  Treatment ~ Age_years + Sex_bcf + Race2_bcf + 
    Ethnicity_bcf + Education_grouped + HEI2015_TOTAL_SCORE_bl,
  data = imputed_data$data,
  estimand = "ATE",
  s.d.denom = "pooled"
)

balance_original <- bal_original$Balance %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  select(variable, smd = Diff.Un) %>%
  mutate(
    variable = str_replace(variable, 
                          "Race2_bcf_Native Hawaiian or other Pacific Islander, Multiracial, Other or Prefer not to say",
                          "Race2_bcf_Others"),
    dataset = "Original Data"
  )

balance_imputed <- bal_imputed$Balance %>%
  as.data.frame() %>%
  rownames_to_column("variable") %>%
  select(variable, smd = Diff.Un) %>%
  mutate(
    variable = str_replace(variable, 
                          "Race2_bcf_Native Hawaiian or other Pacific Islander, Multiracial, Other or Prefer not to say",
                          "Race2_bcf_Others"),
    dataset = "Imputed Data"
  )

balance_combined <- bind_rows(balance_original, balance_imputed)

cat("Original complete cases:", nrow(data_primary_complete), "\n")
cat("Imputed data:", nrow(imputed_data$data), "\n")

p = ggplot(balance_combined, aes(x = abs(smd), y = reorder(variable, abs(smd)), 
                              color = dataset, shape = dataset)) +
  geom_point(size = 3, position = position_dodge(width = 0.5)) +
  geom_vline(xintercept = 0.1, linetype = "dashed", color = "gray50", linewidth = 0.8) +
  geom_vline(xintercept = 0, color = "black", linewidth = 0.5) +
  labs(
    title = "Covariate Balance: Love Plot",
    x = "Absolute Standardized Mean Difference",
    y = "Covariates",
    color = "Dataset",
    shape = "Dataset"
  ) +
  scale_color_manual(values = c("Original Data" = "#E69F00", 
                                "Imputed Data" = "#0072B2")) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    panel.grid.major.y = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    axis.text.y = element_text(size = 9)
  )

ggsave(here::here("Main RCT analyses/fig3.pdf"), p, width=6, height=4)
```
